name: iso_build
on:
  workflow_dispatch:

permissions:
  contents: write
  actions: read

jobs:
  prepare-release:
    runs-on: ubuntu-latest
    steps:
      - uses: styfle/cancel-workflow-action@0.12.1
        with:
          access_token: ${{ github.token }}
      - id: time
        uses: nanzm/get-time-action@v1.1
        with:
          format: 'YYYYMMDDHHmm'
    outputs:
      release_tag: ${{ steps.time.outputs.time }}

  build-release:
    runs-on: ubuntu-latest
    needs: [prepare-release]
    timeout-minutes: 120
    strategy:
      matrix:
        EDITION: [awesome]
        BRANCH: [stable]
        SCOPE: [full]
    steps:
      - name: Free Disk Space (Ubuntu)
        uses: jlumbroso/free-disk-space@main
        with:
          tool-cache: true
          android: true
          dotnet: true
          haskell: true
          large-packages: true
          docker-images: true
          swap-storage: true

      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - uses: styfle/cancel-workflow-action@0.12.1
        with:
          access_token: ${{ github.token }}
       
      - id: time
        uses: nanzm/get-time-action@v1.1
        with:
          format: 'YY.MM'

      - name: image-build-upload
        uses: megvadulthangya/manjaro-iso-action@main
        with:
          iso-profiles-repo: 'https://github.com/megvadulthangya/iso-profiles'
          iso-profiles-branch: 'testing'
          build-mirror: https://mirror.fcix.net/manjaro/
          edition: ${{ matrix.edition }}
          branch: ${{ matrix.branch }}
          scope: ${{ matrix.scope }}
          version: ${{ steps.time.outputs.time }}-NDA-test
          kernel: linux612
          code-name: "Nordic"

      - name: Generate README & Upload to SourceForge
        if: success()
        env:
          SF_USER: ${{ secrets.SF_USERNAME }}
          SF_KEY: ${{ secrets.SF_SSH_KEY }}
          SF_PROJECT: "manjaro-awesome-iso"
          SF_DIR: "Releases/${{ needs.prepare-release.outputs.release_tag }}"
        run: |
          # --- 1. Alapvet≈ë ellen≈ërz√©sek √©s be√°ll√≠t√°sok ---
          if [ -z "$SF_USER" ]; then
            echo "HIBA: Az SF_USER v√°ltoz√≥ √ºres!"
            exit 1
          fi

          mkdir -p ~/.ssh
          echo "$SF_KEY" > ~/.ssh/id_ed25519
          chmod 600 ~/.ssh/id_ed25519
          ssh-keyscan -H frs.sourceforge.net shell.sourceforge.net >> ~/.ssh/known_hosts

          ISO_FILE=$(find . -maxdepth 2 -name "*.iso" | head -n 1)
          SOURCE_DIR=$(dirname "$ISO_FILE")
            
          if [ -z "$ISO_FILE" ]; then
            echo "HIBA: Nem tal√°lhat√≥ ISO f√°jl!"
            exit 1
          fi
          echo "Forr√°s mappa: $SOURCE_DIR"

          README_PATH="$SOURCE_DIR/README.md"
          BUILD_DATE=$(date -u '+%Y-%m-%d %H:%M UTC')
            
          # --- 2. README Gener√°l√°sa (Dinamikus Fejl√©c) ---
          {
            echo "# üèîÔ∏è Manjaro Awesome Respin - Nordic Themed"
            echo ""
            echo "![Maintenance Status](https://img.shields.io/badge/Maintenance-Actively%20maintained%20via%20automated%20CI%2FCD%20pipeline-brightgreen)"
            echo ""
            echo "## üì¶ Build Info"
            echo "- **Date:** $BUILD_DATE"
            echo "- **Version:** ${{ steps.time.outputs.time }}-Respin"
            echo "- **Kernel:** linux612"
            echo ""
            echo "## üîê Checksums"
          } > "$README_PATH"

          # Checksum loop
          for ext in sha1 sha256 sha512; do
            hash_file=$(find "$SOURCE_DIR" -maxdepth 1 -name "*.$ext" | head -n 1)
            if [ -f "$hash_file" ]; then
              LABEL=$(echo "$ext" | tr 'a-z' 'A-Z')
              HASH_CODE=$(awk '{print $1}' "$hash_file")
              echo "- **$LABEL:** \`$HASH_CODE\`" >> "$README_PATH"
            fi
          done

          # --- 3. Statikus Tartalom (A l√©nyeg!) ---
          # Itt f≈±zz√ºk hozz√° a le√≠r√°st, bele√©rtve a h√°l√≥zati jav√≠t√°st is
          cat <<EOF >> "$README_PATH"

          ---

          ## ‚öôÔ∏è Overview / √Åttekint√©s TESTING ONLY!!!!!!!

          This project is a **custom Manjaro Linux ISO** designed for a cohesive, visually harmonious, and ready-to-work environment.

          **New in this release:** The installation process is now seamless. **No post-install scripts, no hacks.** Just install via Calamares, reboot, and the system is fully configured and ready to use.

          Ez a projekt egy **egyedi Manjaro Linux ISO**, amelyet egy egys√©ges, vizu√°lisan harmonikus √©s munk√°ra k√©sz k√∂rnyezetnek terveztem.

          **√öjdons√°g:** A telep√≠t√©si folyamat mostant√≥l teljesen z√∂kken≈ëmentes. **Nincsenek ut√≥lagos scriptek, nincsenek "hack"-ek.** Csak telep√≠tsd a szok√°sos m√≥don, ind√≠tsd √∫jra, √©s a rendszer azonnal haszn√°latra k√©sz.

          ---

          ## üöÄ Key Features / F≈ëbb jellemz≈ëk

          ### üñ•Ô∏è Desktop Environment
          * **Window Manager:** AwesomeWM 4.x (Github version)
          * **Theme:** Unified **Nordic** color scheme across GTK, Kvantum, LightDM, and AwesomeWM.
          * **Applets:** **Awesome-rofi** fork, patched for seamless integration.

          ### üì∏ Creative Suite (Photography)
          The ISO comes with a pre-populated **Darktable database**.
          * **Stefano Ferro's Styles:** Includes Traveller, Vintage, Dark Tones, Dodge & Burn.
          * **t3mujinpack:** Extensive film emulation pack.

          ### üõ†Ô∏è System Core
          * **Base:** Manjaro Stable
          * **Filesystem:** BTRFS + Timeshift (automatic snapshot management).
          * **Shell:** Fish (root), Zsh/Bash (user).

          ### üåê Connectivity & Stability Fixes / H√°l√≥zati Stabilit√°s
          Unlike standard Manjaro, this ISO **fixes the infamous "Limited Connectivity" / "No Internet" false positives**.
          
          * **The Problem:** Manjaro's upstream servers often have expired SSL certificates or strict firewall rules, causing NetworkManager and Calamares to report connection failures even when your internet is working perfectly.
          * **The Fix:** I have overridden the connectivity checks to bypass Manjaro's infrastructure entirely.
            * **NetworkManager:** Configured to ping **Cloudflare** (\`cp.cloudflare.com\`) for instant, reliable status detection.
            * **Calamares Installer:** Verifies connection via \`1.1.1.1\` instead of unreliable mirrors.
          * **Result:** No more confusing error icons or stalled installations due to upstream server issues.

          A standard Manjar√≥val ellent√©tben ez az ISO **jav√≠tja a h√≠rhedt "Korl√°tozott kapcsolat" / "Nincs Internet" t√©ves hiba√ºzeneteket**.
          
          * **A probl√©ma:** A Manjaro saj√°t szerverei gyakran k√ºzdenek lej√°rt SSL tan√∫s√≠tv√°nyokkal vagy t√∫l szigor√∫ t≈±zfal szab√°lyokkal, ami miatt a NetworkManager √©s a telep√≠t≈ë akkor is hib√°t jelez, ha az interneted t√∂k√©letesen m≈±k√∂dik.
          * **A megold√°s:** Fel√ºlb√≠r√°ltam a kapcsol√≥d√°si ellen≈ërz√©seket, √≠gy a rendszer teljesen megker√ºli a Manjaro instabil infrastrukt√∫r√°j√°t.
             * **NetworkManager:** A **Cloudflare** glob√°lis h√°l√≥zat√°t (\`cp.cloudflare.com\`) haszn√°lja a gyors √©s megb√≠zhat√≥ √°llapotjelz√©shez.
             * **Calamares Telep√≠t≈ë:** A \`1.1.1.1\` c√≠men ellen≈ërzi a kapcsolatot a megb√≠zhatatlan t√ºk√∂rszerverek helyett.
          * **Eredm√©ny:** Nincs t√∂bb megt√©veszt≈ë hiba√ºzenet, k√©rd≈ëjeles wifi ikon vagy emiatt megakad√≥ telep√≠t√©s.

          ---

          ## üì∫ Video Walkthrough / Vide√≥s bemutat√≥

          [![Manjaro Awesome Respin Showcase](https://img.youtube.com/vi/7Z-CN08_2U8/maxresdefault.jpg)](https://youtu.be/7Z-CN08_2U8)

          ---

          ## ‚òï Support / T√°mogat√°s

          If you find this project useful, please support the development: / Ha hasznosnak tal√°lod a projektet, t√°mogasd a fejleszt√©st:

          üëâ [Buy me a coffee](https://buymeacoffee.com/rohambili)

          ---

          ## üß† Credits / K√©sz√≠tette

          * **Base:** [Manjaro Linux](https://manjaro.org/)
          * **Theme:** [Nordic Theme](https://github.com/EliverLara/Nordic)
          * **WM:** [Awesome Copycats Manjaro](https://github.com/megvadulthangya/awesome-copycats-manjaro) & [Luca CPZ](https://github.com/lcpz)
          * **Photo:** [Stefano Ferro (MEL365)](https://mel365.com/) & [t3mujinpack](https://t3mujinpack.github.io/)
          * **Respin by:** [@megvadulthangya](https://github.com/megvadulthangya)

          ---
          
          ## üìú Recent Changes (Git Log)
          EOF

          # --- 4. Git Log hozz√°ad√°sa a v√©g√©re ---
          git log -n 50 --pretty=format:"* %s (%h) - %ad" --date=short >> "$README_PATH" || echo "Git history not available." >> "$README_PATH"
            
          echo "" >> "$README_PATH"
          echo "README gener√°lva: $README_PATH"

          # --- 5. Felt√∂lt√©s ---
          echo "Feltoltes inditasa..."
          echo -e "mkdir /home/frs/project/$SF_PROJECT/Releases\n mkdir /home/frs/project/$SF_PROJECT/$SF_DIR" > sftp_commands.txt
          sftp -o IdentitiesOnly=yes -o StrictHostKeyChecking=no -i ~/.ssh/id_ed25519 -b sftp_commands.txt $SF_USER@frs.sourceforge.net || true
            
          rsync -avP -e "ssh -o IdentitiesOnly=yes -o StrictHostKeyChecking=no -i ~/.ssh/id_ed25519" "$SOURCE_DIR"/*.iso "$SOURCE_DIR"/*.sha* "$README_PATH" "$SF_USER@frs.sourceforge.net:/home/frs/project/$SF_PROJECT/$SF_DIR/"
