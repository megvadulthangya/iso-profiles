name: iso_build
on:
  workflow_dispatch:
#   schedule:
#     - cron:  '30 2 * * 1'

permissions:
  contents: write
  actions: read

jobs:
  prepare-release:
    runs-on: ubuntu-22.04
    timeout-minutes: 120
    steps:
      - uses: styfle/cancel-workflow-action@0.12.1
        with:
          access_token: ${{ github.token }}
      - id: time
        uses: nanzm/get-time-action@v1.1
        with:
          format: 'YYYYMMDDHHmm'
    outputs:
      release_tag: ${{ steps.time.outputs.time }}

  build-release:
    runs-on: ubuntu-22.04
    needs: [prepare-release]
    timeout-minutes: 120
    strategy:
      matrix:
        EDITION: [awesome]
        BRANCH: [stable]
        SCOPE: [full]
    steps:
      # --- 0. L√âP√âS: T√°rhely felszabad√≠t√°sa (K√ñTELEZ≈ê!) ---
      # Ez t√∂rli a felesleges Android/Dotnet/stb. szemetet, hogy elf√©rjen az ISO.
      - name: Free Disk Space (Ubuntu)
        uses: jlumbroso/free-disk-space@main
        with:
          tool-cache: true
          android: true
          dotnet: true
          haskell: true
          large-packages: true
          docker-images: true
          swap-storage: true

      # 1. L√âP√âS: Rep√≥ let√∂lt√©se
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - uses: styfle/cancel-workflow-action@0.12.1
        with:
          access_token: ${{ github.token }}
      
      - id: time
        uses: nanzm/get-time-action@v1.1
        with:
          format: 'YY.MM'     

      # 2. L√âP√âS: ISO √âp√≠t√©se
      - name: image-build-upload
        uses: megvadulthangya/manjaro-iso-action@main
        with:
          iso-profiles-repo: 'https://github.com/megvadulthangya/iso-profiles'
          iso-profiles-branch: 'master'   # Az √∫j f≈ë √°gad
          build-mirror: https://mirror.netcologne.de/manjaro/
          edition: ${{ matrix.edition }}
          branch: ${{ matrix.branch }}
          scope: ${{ matrix.scope }}
          version: ${{ steps.time.outputs.time }}-Respin
          kernel: linux612
          code-name: "Nordic-Respin"

      # 3. L√âP√âS: Readme gener√°l√°s √©s Felt√∂lt√©s
      - name: Generate README & Upload to SourceForge
        if: success()
        env:
          SF_USER: ${{ secrets.SF_USERNAME }}
          SF_KEY: ${{ secrets.SF_SSH_KEY }}
          SF_PROJECT: "manjaro-awesome-iso"
          SF_DIR: "Releases/${{ needs.prepare-release.outputs.release_tag }}"
        run: |
          # --- 0. Biztons√°gi ellen≈ërz√©s ---
          if [ -z "$SF_USER" ]; then
            echo "HIBA: Az SF_USER v√°ltoz√≥ √ºres! Ellen≈ërizd a GitHub Secrets be√°ll√≠t√°sokat (SF_USERNAME)!"
            exit 1
          fi

          # --- 1. SSH be√°ll√≠t√°s ---
          mkdir -p ~/.ssh
          echo "$SF_KEY" > ~/.ssh/id_ed25519
          chmod 600 ~/.ssh/id_ed25519
          ssh-keyscan -H frs.sourceforge.net shell.sourceforge.net >> ~/.ssh/known_hosts

          # --- 2. ISO megkeres√©se ---
          ISO_FILE=$(find . -type f -name "*.iso" | head -n 1)
          SOURCE_DIR=$(dirname "$ISO_FILE")
          if [ -z "$ISO_FILE" ]; then
            echo "HIBA: Nem tal√°lhat√≥ ISO f√°jl!"
            exit 1
          fi
          echo "Forr√°s mappa: $SOURCE_DIR"

          # --- 3. README GENER√ÅL√ÅS ---
          README_PATH="$SOURCE_DIR/README.md"
          
          # C√≠m be√°ll√≠t√°sa (konzisztens a megbesz√©ltekkel)
          echo "# Manjaro Awesome Respin (Nordic Themed)" > "$README_PATH"
          echo "" >> "$README_PATH"

          # Legacy Intel GPU Support Info
          echo "## üîß Legacy Intel GPU Support / R√©gi Intel GPU Jav√≠t√°s" >> "$README_PATH"
          echo "This system automatically applies fixes for legacy Intel Graphics (Mobile 4 Series)." >> "$README_PATH"
          echo "Affected applications (like gThumb, geeqie etc.) are patched individually to prevent crashes." >> "$README_PATH"
          echo "" >> "$README_PATH"
          echo "üé• **Video & Gaming:**" >> "$README_PATH"
          echo "Video players (mpv) and Games run with full Hardware Acceleration by default." >> "$README_PATH"
          echo "No special configuration is needed." >> "$README_PATH"
          echo "" >> "$README_PATH"

          # Build inf√≥k
          echo "## Build Info" >> "$README_PATH"
          echo "- **Date:** $(date -u '+%Y-%m-%d %H:%M UTC')" >> "$README_PATH"
          echo "- **Version:** ${{ steps.time.outputs.time }}-Respin" >> "$README_PATH"
          echo "- **Kernel:** linux612" >> "$README_PATH"
          echo "" >> "$README_PATH"

          # --- FASTFETCH (JAV√çTVA: Sima URL, nincs Markdown hiba) ---
          echo "## Runner Hardware (Fastfetch)" >> "$README_PATH"
          echo "Built on GitHub Actions runner:" >> "$README_PATH"
          echo '```' >> "$README_PATH"
          
          (
            echo "Fastfetch let√∂lt√©se..."
            wget -qO fastfetch.deb [https://github.com/fastfetch-cli/fastfetch/releases/latest/download/fastfetch-linux-amd64.deb](https://github.com/fastfetch-cli/fastfetch/releases/latest/download/fastfetch-linux-amd64.deb)
            sudo dpkg -i fastfetch.deb
          ) || echo "Fastfetch telep√≠t√©s sikertelen."

          if command -v fastfetch &> /dev/null; then
            fastfetch --pipe >> "$README_PATH"
          else
            # B-terv
            echo "Fallback Info:" >> "$README_PATH"
            lscpu | grep "Model name" >> "$README_PATH" || true
            free -h >> "$README_PATH" || true
          fi
          echo '```' >> "$README_PATH"
          echo "" >> "$README_PATH"
          # -------------------------------------------

          # Checksums
          echo "## Checksums" >> "$README_PATH"
          echo '```' >> "$README_PATH"
          cat "$SOURCE_DIR"/*.sha* >> "$README_PATH" || echo "Checksums available as separate files."
          echo '```' >> "$README_PATH"
          echo "" >> "$README_PATH"
          
          # Git Log
          echo "## Recent Changes" >> "$README_PATH"
          echo "Last 10 commits from repository:" >> "$README_PATH"
          echo "" >> "$README_PATH"
          git log -n 10 --pretty=format:"* %s (%h) - %ad" --date=short >> "$README_PATH" || echo "Git history not available." >> "$README_PATH"

          echo "README gener√°lva: $README_PATH"

          # --- 4. Felt√∂lt√©s ---
          echo "SourceForge inicializ√°l√°sa ($SF_USER)..."
          ssh -o IdentitiesOnly=yes -o StrictHostKeyChecking=no -i ~/.ssh/id_ed25519 $SF_USER@shell.sourceforge.net "create" || true
          
          echo "Mapp√°k l√©trehoz√°sa..."
          echo -e "mkdir /home/frs/project/$SF_PROJECT/Releases\n mkdir /home/frs/project/$SF_PROJECT/$SF_DIR" > sftp_commands.txt
          sftp -o IdentitiesOnly=yes -o StrictHostKeyChecking=no -i ~/.ssh/id_ed25519 -b sftp_commands.txt $SF_USER@frs.sourceforge.net || true
          
          echo "Felt√∂lt√©s..."
          rsync -avP -e "ssh -o IdentitiesOnly=yes -o StrictHostKeyChecking=no -i ~/.ssh/id_ed25519" "$SOURCE_DIR"/*.iso "$SOURCE_DIR"/*.sha* "$README_PATH" "$SF_USER@frs.sourceforge.net:/home/frs/project/$SF_PROJECT/$SF_DIR/"
