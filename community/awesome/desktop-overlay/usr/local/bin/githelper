#!/bin/bash

# GitHub helper script - v4.0 (Editor Support)
# Location: /usr/local/bin/githelper

# --- 1. CONFIGURATION ---

detect_language() {
    local lang=$(echo "$LANG" | cut -d'_' -f1)
    if [ "$lang" = "hu" ]; then LANGUAGE="hu"; else LANGUAGE="en"; fi
}

init_texts() {
    INSTRUCT_BOX_TITLE="=== ðŸ“ INPUT INSTRUCTIONS ==="
    INSTRUCT_LINE_1="â€¢ PASTE your message below."
    INSTRUCT_LINE_2="â€¢ TO SAVE: Press [ENTER], then [CTRL+D] (once or twice)."
    
    if [ "$LANGUAGE" = "hu" ]; then
        TITLE="=== GitHub Helper Script v4.0 ==="
        NOT_GIT_REPO="âŒ HIBA: Ez nem Git mappa!"
        ADDING_CHANGES="1. ðŸ“¦ VÃ¡ltozÃ¡sok hozzÃ¡adÃ¡sa..."
        ENTER_COMMIT_HEADER="2. âœï¸  COMMIT ÃœZENET MEGADÃSA"
        CONFIRM_HEADER="3. ðŸ” ELLENÅRZÃ‰S (Ezt fogom bekÃ¼ldeni):"
        # FrissÃ­tett kÃ©rdÃ©s opciÃ³k:
        CONFIRM_QUESTION="OpciÃ³k: [i]gen (Commit) / [e]dit (SzerkesztÃ©s) / [n]em (MÃ©gse): "
        CANCELLED="âŒ MegszakÃ­tva. Semmi nem tÃ¶rtÃ©nt."
        CREATING_COMMIT="4. ðŸ’¾ Commit kÃ©szÃ­tÃ©se..."
        PUSHING="5. ðŸš€ Push GitHubra..."
        SUCCESS="âœ… SIKER: Minden kÃ©sz!"
        EMPTY_MSG="âŒ Hiba: Ãœres Ã¼zenet!"
    else
        TITLE="=== GitHub Helper Script v4.0 ==="
        NOT_GIT_REPO="âŒ ERROR: Not a Git repository!"
        ADDING_CHANGES="1. ðŸ“¦ Adding changes..."
        ENTER_COMMIT_HEADER="2. âœï¸  ENTER COMMIT MESSAGE"
        CONFIRM_HEADER="3. ðŸ” VERIFY (I will commit this):"
        # Updated question options:
        CONFIRM_QUESTION="Options: [y]es (Commit) / [e]dit (Open Nano) / [n]o (Cancel): "
        CANCELLED="âŒ Cancelled. No changes made."
        CREATING_COMMIT="4. ðŸ’¾ Creating commit..."
        PUSHING="5. ðŸš€ Pushing to GitHub..."
        SUCCESS="âœ… SUCCESS: All done!"
        EMPTY_MSG="âŒ Error: Empty message!"
    fi
}

check_git_config() {
    if [ -z "$(git config --global user.name)" ]; then
        echo "Git user config missing!"
        read -p "Name: " name
        read -p "Email: " email
        git config --global user.name "$name"
        git config --global user.email "$email"
    fi
}

# --- MAIN ---

main() {
    detect_language
    init_texts

    echo "$TITLE"

    if ! git rev-parse --git-dir > /dev/null 2>&1; then
        echo -e "\033[0;31m$NOT_GIT_REPO\033[0m"
        exit 1
    fi
    check_git_config

    echo "$ADDING_CHANGES"
    git add .

    # --- INPUT ---
    echo ""
    echo "$ENTER_COMMIT_HEADER"
    echo -e "\033[1;36m----------------------------------------\033[0m"
    echo -e "$INSTRUCT_LINE_1"
    echo -e "$INSTRUCT_LINE_2"
    echo -e "\033[1;36m----------------------------------------\033[0m"
    
    if ! mapfile -t commit_lines; then
        if [ ${#commit_lines[@]} -eq 0 ]; then
             echo "$EMPTY_MSG"
             exit 1
        fi
    fi
    
    commit_message=$(printf "%s\n" "${commit_lines[@]}")
    commit_message=$(echo "$commit_message" | sed -e :a -e '/^\n*$/{$d;N;};/\n$/ba')

    if [ -z "$commit_message" ]; then
        echo "$EMPTY_MSG"
        exit 1
    fi

    # --- VERIFICATION LOOP (With Edit Option) ---
    while true; do
        echo ""
        echo -e "\033[1;35m$CONFIRM_HEADER\033[0m" 
        echo "----------------------------------------"
        echo "$commit_message"
        echo "----------------------------------------"
        
        # Read user choice
        read -p "$CONFIRM_QUESTION" choice < /dev/tty
        
        case "$choice" in
            [YyIi]*) 
                # YES -> Break loop and proceed
                break 
                ;;
            [Ee]*)
                # EDIT -> Open in Nano
                # Create temp file
                TMPFILE=$(mktemp)
                echo "$commit_message" > "$TMPFILE"
                
                # Open editor (Nano by default)
                ${EDITOR:-nano} "$TMPFILE"
                
                # Read back the edited message
                commit_message=$(cat "$TMPFILE")
                rm "$TMPFILE"
                
                # Check if empty after edit
                commit_message=$(echo "$commit_message" | sed -e :a -e '/^\n*$/{$d;N;};/\n$/ba')
                if [ -z "$commit_message" ]; then
                    echo "$EMPTY_MSG"
                    exit 1
                fi
                # Loop restarts to show the NEW message
                ;;
            [Nn]*)
                # NO -> Exit
                echo "$CANCELLED"
                exit 0
                ;;
            *)
                # Invalid input -> Ask again
                ;;
        esac
    done

    # --- EXECUTION ---
    echo "$CREATING_COMMIT"
    git commit -m "$commit_message"

    echo "$PUSHING"
    git push

    echo "$SUCCESS"
}

main "$@"
