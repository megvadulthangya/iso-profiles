#!/bin/bash

# GitHub helper script - v3.1 (Mapfile edition)
# Location: /usr/local/bin/githelper

# --- 1. CONFIGURATION ---

detect_language() {
    local lang=$(echo "$LANG" | cut -d'_' -f1)
    if [ "$lang" = "hu" ]; then LANGUAGE="hu"; else LANGUAGE="en"; fi
}

init_texts() {
    INSTRUCT_BOX_TITLE="=== üìù INPUT INSTRUCTIONS ==="
    INSTRUCT_LINE_1="‚Ä¢ PASTE or TYPE your message below."
    INSTRUCT_LINE_2="‚Ä¢ Press [ENTER] for new lines."
    INSTRUCT_LINE_3="‚Ä¢ TO SAVE: Press [ENTER], then [CTRL+D] (once or twice)."
    
    if [ "$LANGUAGE" = "hu" ]; then
        TITLE="=== GitHub Helper Script v3.1 ==="
        NOT_GIT_REPO="‚ùå HIBA: Ez nem Git mappa!"
        ADDING_CHANGES="1. üì¶ V√°ltoz√°sok hozz√°ad√°sa..."
        ENTER_COMMIT_HEADER="2. ‚úçÔ∏è  COMMIT √úZENET MEGAD√ÅSA"
        CONFIRM_HEADER="3. üîç ELLEN≈êRZ√âS (Ezt fogom bek√ºldeni):"
        CONFIRM_QUESTION="Mehet a commit √©s a push? (i/n): "
        CANCELLED="‚ùå Megszak√≠tva. Semmi nem t√∂rt√©nt."
        CREATING_COMMIT="4. üíæ Commit k√©sz√≠t√©se..."
        PUSHING="5. üöÄ Push GitHubra..."
        SUCCESS="‚úÖ SIKER: Minden k√©sz!"
        EMPTY_MSG="‚ùå Hiba: √úres √ºzenet!"
    else
        TITLE="=== GitHub Helper Script v3.1 ==="
        NOT_GIT_REPO="‚ùå ERROR: Not a Git repository!"
        ADDING_CHANGES="1. üì¶ Adding changes..."
        ENTER_COMMIT_HEADER="2. ‚úçÔ∏è  ENTER COMMIT MESSAGE"
        CONFIRM_HEADER="3. üîç VERIFY (I will commit this):"
        CONFIRM_QUESTION="Commit and push now? (y/n): "
        CANCELLED="‚ùå Cancelled. No changes made."
        CREATING_COMMIT="4. üíæ Creating commit..."
        PUSHING="5. üöÄ Pushing to GitHub..."
        SUCCESS="‚úÖ SUCCESS: All done!"
        EMPTY_MSG="‚ùå Error: Empty message!"
    fi
}

check_git_config() {
    if [ -z "$(git config --global user.name)" ]; then
        echo "Git user config missing!"
        read -p "Name: " name
        read -p "Email: " email
        git config --global user.name "$name"
        git config --global user.email "$email"
    fi
}

# --- MAIN ---

main() {
    detect_language
    init_texts

    echo "$TITLE"

    # 1. Check Git
    if ! git rev-parse --git-dir > /dev/null 2>&1; then
        echo -e "\033[0;31m$NOT_GIT_REPO\033[0m"
        exit 1
    fi
    check_git_config

    # 2. Add Changes
    echo "$ADDING_CHANGES"
    git add .

    # 3. Input Message (JAV√çTOTT MAPFILE MET√ìDUS)
    echo ""
    echo "$ENTER_COMMIT_HEADER"
    echo -e "\033[1;36m----------------------------------------\033[0m"
    echo -e "$INSTRUCT_LINE_1"
    echo -e "$INSTRUCT_LINE_2"
    echo -e "\033[1;33m$INSTRUCT_LINE_3\033[0m"
    echo -e "\033[1;36m----------------------------------------\033[0m"
    
    # mapfile olvas√°sa a stdin-r≈ël. 
    # Ez a legstabilabb m√≥dszer a t√∂bbsoros paste-hez Bash-ben.
    if ! mapfile -t commit_lines; then
        # Ha a mapfile valami√©rt 'fail'-al t√©rne vissza (ritka), de van adat
        if [ ${#commit_lines[@]} -eq 0 ]; then
             echo "$EMPTY_MSG"
             exit 1
        fi
    fi
    
    # T√∂mb √∂sszef≈±z√©se stringg√©, sort√∂r√©sekkel
    commit_message=$(printf "%s\n" "${commit_lines[@]}")

    # √úres sorok lev√°g√°sa a v√©g√©r≈ël (trim)
    commit_message=$(echo "$commit_message" | sed -e :a -e '/^\n*$/{$d;N;};/\n$/ba')

    if [ -z "$commit_message" ]; then
        echo "$EMPTY_MSG"
        exit 1
    fi

    # 4. Verification
    echo ""
    echo -e "\033[1;35m$CONFIRM_HEADER\033[0m" 
    echo "----------------------------------------"
    echo "$commit_message"
    echo "----------------------------------------"
    
    read -p "$CONFIRM_QUESTION" confirm < /dev/tty
    # Megjegyz√©s: a '< /dev/tty' fontos, mert a mapfile ut√°n a stdin bez√°r√≥dhat
    
    if [[ ! "$confirm" =~ ^[YyIi] ]]; then
        echo "$CANCELLED"
        exit 0
    fi

    # 5. Commit
    echo "$CREATING_COMMIT"
    git commit -m "$commit_message"

    # 6. Push
    echo "$PUSHING"
    git push

    echo "$SUCCESS"
}

main "$@"
